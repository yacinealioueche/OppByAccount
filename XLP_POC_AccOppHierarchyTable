public with sharing class XLP_POC_AccOppHierarchyTable {

    // Max depth of account hierarchy to traverse
    private static final Integer MAX_DEPTH = 5;

    /**
     * Returns Opportunities for the given Account and all its descendants
     * up to MAX_DEPTH levels.
     */
    @AuraEnabled(cacheable=true)
    public static List<Opportunity> getHierarchyOpportunities(Id accountId) {
        if (accountId == null) {
            return new List<Opportunity>();
        }

        Set<Id> accountIds = collectDescendantAccounts(accountId, MAX_DEPTH);

        if (accountIds.isEmpty()) {
            return new List<Opportunity>();
        }

        // Adjust fields as needed; keep it lean
        List<Opportunity> opps = [
            SELECT Id,
                   Name,
                   StageName,
                   Amount,
                   CloseDate,
                   AccountId,
                   Account.Name,
                   XLP_BrokerName__c,
                   XLP_BrokerName__r.Name,
                   OwnerId
            FROM Opportunity
            WHERE XLP_BrokerName__c IN :accountIds
            ORDER BY CloseDate DESC
            LIMIT 2000
        ];

        return opps;
    }

    /**
     * Updates opportunities from inline edit.
     */
    @AuraEnabled
    public static void updateOpportunities(List<Opportunity> opportunities) {
        if (opportunities == null || opportunities.isEmpty()) {
            return;
        }
        // Simple DML â€“ you can add extra validation / error handling as needed
        update opportunities;
    }

    /**
     * Collects all descendant accounts up to maxDepth levels
     * including the root account.
     */
    private static Set<Id> collectDescendantAccounts(Id rootId, Integer maxDepth) {
        Set<Id> allIds = new Set<Id>();
        Set<Id> currentLevel = new Set<Id>{ rootId };

        Integer depth = 0;

        while (!currentLevel.isEmpty() && depth < maxDepth) {
            // Add current level to overall set
            allIds.addAll(currentLevel);

            // Find direct children of any account in currentLevel
            List<Account> children = [
                SELECT Id
                FROM Account
                WHERE ParentId IN :currentLevel
                LIMIT 5000
            ];

            currentLevel.clear();
            for (Account child : children) {
                if (!allIds.contains(child.Id)) {
                    currentLevel.add(child.Id);
                }
            }

            depth++;
        }

        return allIds;
    }
}
